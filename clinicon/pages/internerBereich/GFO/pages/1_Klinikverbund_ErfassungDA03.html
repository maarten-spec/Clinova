<!doctype html>


<html lang="de">


<head>


  <meta charset="utf-8" />


  <meta name="viewport" content="width=device-width, initial-scale=1" />


  <title>CliniCon - Standort</title>
  <link rel="stylesheet" href="../../../../assets/typography.css" />

  <style>


    :root{


      --bg:#f5f7fb;


      --panel:#ffffff;


      --muted:#94a3b8;


      --text:#0f172a;


      --line:#e2e8f0;


      --accent:#2563eb;


      --accent-weak:#dbeafe;


      --accent-strong:#1d4ed8;


      --success:#16a34a;
      --font-size-h1:1.9rem;
      --font-size-h2:1.5rem;
      --font-size-h3:1.2rem;
      --font-size-h4:1.05rem;

      --danger:#b91c1c;
      --font-base:"Roboto","Go","Segoe UI","Helvetica",Arial,sans-serif;
      --font-size-base:16px;
      --line-height-base:1.6;


    }

    *{box-sizing:border-box}


    html,body{height:100%}


    body{
      margin:0;
      font-family:var(--font-base);
      font-size:var(--font-size-base);
      line-height:var(--line-height-base);
      color:var(--text); background:var(--bg);
    }
    h1,h2,h3,h4{
      margin:0 0 8px;
      letter-spacing:.01em;
      line-height:1.3;
      color:var(--text);
    }
    h1{ font-size:var(--font-size-h1); }
    h2{ font-size:var(--font-size-h2); }
    h3{ font-size:var(--font-size-h3); }
    h4{ font-size:var(--font-size-h4); }





    .shell{display:grid; grid-template-columns:240px 1fr; min-height:100dvh}





    .side{


      position:sticky; top:0; height:100dvh; background:#ffffffcc; backdrop-filter:saturate(180%) blur(10px);


      border-right:1px solid var(--line); display:flex; flex-direction:column; align-items:flex-start; gap:12px; padding:16px 12px;


      width:240px; overflow:hidden


    }





    .brand{display:flex; align-items:center; gap:10px; padding:6px 8px; width:100%}


    .brand img{width:180px; height:auto; object-fit:contain}


    .brand .title{font-weight:700; letter-spacing:.2px; white-space:nowrap}





    .nav{display:flex; flex-direction:column; gap:6px; width:100%; margin-top:8px}


    .nav a{ display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text);


      padding:10px 12px; border-radius:12px; border:1px solid transparent; transition:.15s ease all }


    .nav a:hover{ background:var(--accent-weak); border-color:#bfd7ff }


    .nav a.active{ background:var(--accent); color:white }


    .nav svg{ min-width:22px }





    header{


      display:flex; align-items:flex-start; justify-content:space-between;


      gap:16px; padding:20px 24px; border-bottom:1px solid var(--line); background:#fff; position:sticky; top:0; z-index:2


    }


    .topbar-left h1{ font-size:var(--font-size-h1); }


    .topbar-left p{ margin:6px 0 0; color:var(--muted); font-size:1rem }


    .product-logo{ height:56px; width:auto; object-fit:contain }





    main{
      padding:24px;
      display:grid;
      gap:20px;
      grid-template-columns:repeat(12,1fr);
      margin:0 auto;
      width:100%;
    }


    .card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:24px; box-shadow:0 18px 36px rgba(15,23,42,.08) }





    .hero{ grid-column:1/-1; display:grid; gap:16px }


    .hero-header{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }


    .hero-header h2{ margin:0; font-size:var(--font-size-h2) }


    .hero-meta{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }


    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:999px; border:1px solid rgba(37,99,235,0.35); color:var(--accent-strong); background:var(--accent-weak); font-weight:600; letter-spacing:.05em }


    .tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; border:1px solid var(--line); background:rgba(37,99,235,0.1); color:var(--accent-strong); text-decoration:none; font-weight:600 }


    .tag svg{ color:var(--accent-strong) }


    .tag.muted{ background:transparent; color:var(--muted); border-style:dashed }





    .status-grid{ grid-column:1/-1; display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)) }


    .status-card{ display:grid; gap:6px }


    .status-card strong{ font-size:2rem }


    .status-card span{ color:var(--muted); font-size:.95rem }


    .status-card .value.positive{ color:var(--success) }


    .status-card .value.negative{ color:var(--danger) }





    .actions-card{ grid-column:1/-1; display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between }


    .btn-group{ display:flex; flex-wrap:wrap; gap:12px }


    .muted{ color:var(--muted); font-size:.95rem }





    .btn{ appearance:none; border:none; border-radius:12px; padding:12px 20px; font-weight:600; cursor:pointer; transition:transform .08s ease, box-shadow .2s ease, background .2s ease }


    .btn.primary{ background:linear-gradient(120deg,#2563eb,#3b82f6); color:#f8fafc; box-shadow:0 12px 28px rgba(37,99,235,.35) }


    .btn.primary:hover{ background:linear-gradient(120deg,#1d4ed8,#2563eb); box-shadow:0 16px 34px rgba(37,99,235,.4) }


    .btn.secondary{ background:#fff; color:var(--accent-strong); border:2px solid rgba(37,99,235,.4) }


    .btn.secondary:hover{ background:rgba(37,99,235,.08); box-shadow:0 10px 24px rgba(37,99,235,.24) }


    .btn.link{ background:transparent; color:var(--text); border:2px solid rgba(15,23,42,.15) }


    .btn.link:hover{ background:rgba(15,23,42,.06); box-shadow:0 8px 18px rgba(15,23,42,.12) }





    .table-card{ grid-column:1/-1 }


    .table-wrap{ overflow:auto }


    table{ width:100%; border-collapse:collapse; min-width:960px }


    thead th{ position:sticky; top:0; background:var(--text); color:#fff; padding:14px 12px; text-align:left; font-size:.88rem; letter-spacing:.02em }


    tbody td, tbody th, tfoot td{ padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:middle }


    tbody td.name-cell{ min-width:280px; font-weight:600 }


    tbody td.name-cell input{ border:none; background:transparent; font-weight:600; padding:0; color:inherit; pointer-events:none }


    tbody td.name-cell input:focus{ outline:none; box-shadow:none }


    tbody tr:nth-child(even){ background:#f8fafc }


    tbody input, tbody select{ width:100%; padding:6px 8px; border-radius:8px; border:1px solid #cbd5f5; font:inherit; box-sizing:border-box }


    tbody input:focus, tbody select:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.25) }


    tfoot td{ font-weight:700; background:#f1f5fb }


    .pos{ color:var(--success); font-weight:700 }


    .neg{ color:var(--danger); font-weight:700 }





    footer{ padding:18px 24px; grid-column:1/-1; color:var(--muted); text-align:right }





    @media (max-width:960px){


      .shell{ grid-template-columns:1fr }


      .side{ position:relative; height:auto; width:100%; flex-direction:row; align-items:center; justify-content:space-between; padding:12px 16px }


      .nav{ flex-direction:row; overflow-x:auto; padding-bottom:4px }


      .nav a{ white-space:nowrap }


      header{ position:relative }


    }


    @media (max-width:720px){


      main{ padding:20px; grid-template-columns:repeat(6,1fr) }


      .hero{ padding:20px; gap:12px }


    }


    @media (max-width:520px){


      main{ grid-template-columns:repeat(4,1fr) }


      header{ flex-direction:column; align-items:flex-start }


      .product-logo{ height:48px }


    }


  </style>


</head>


<body>


  <div class="shell">


    <aside class="side">


      <a class="brand" href="#">


        <img src="Bilder/Log.jpg" alt="GFO Logo" />


        <span class="title" aria-hidden="true"></span>


      </a>





      <nav class="nav">


        <a href="index.html">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/></svg>


          <span>Start</span>


        </a>        <a class="active" href="1_klinikverbund.html">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>


          <span>Klinikverbund</span>


        </a>        <a href="1_Benchmark.html">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg>


          <span>Benchmark</span>


        </a>        <a href="stellenplan-insights.html">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h10M4 18h7"/></svg>


          <span>Stellenplan</span>


        </a>        <a href="#">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M10 8h4v8h-4z"/></svg>


          <span>Stellenplan&nbsp;Berechnung</span>


        </a>        <a href="#">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 21V9l8-6 8 6v12"/><path d="M9 21V12h6v9"/></svg>


          <span>Station&nbsp;/ Abteilung</span>


        </a>        <a class="nav-spaced" href="Fachabteilungen.html">


          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 21V9l8-6 8 6v12"/><path d="M9 21V12h6v9"/></svg>


          <span>Fachabteilungen&nbsp;GFO</span>


        </a>


      </nav>


    </aside>





    <div>


      <header>


        <div class="topbar-left">


          <h1></h1>
          <p></p>


        </div>


        <img class="product-logo" src="Bilder/CliniConLogo.png" alt="CliniCon Logo" />


      </header>





      <main>


        <section class="hero card">


          <div class="hero-header">


            <span id="siteCode" class="pill">[CODE]</span>


            <h2 id="siteTitle">Standortname</h2>


          </div>


          <p id="siteIntro">Die Mastertabelle fasst alle relevanten Funktionsdienste des ausgew&auml;hlten Standorts zusammen.</p>


          <div class="hero-meta">


            <a id="clusterLink" class="tag" href="1_klinikverbund.html">


              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M3 21h18"/></svg>


              <span id="clusterName">Klinikverbund</span>


            </a>


            <span id="siteAddress" class="tag muted">Adresse wird erg&auml;nzt</span>


          </div>


        </section>





        <section class="status-grid card">


          <div class="status-card">


            <span>Planstellen (SOLL)</span>


            <strong id="statSoll" class="value">0</strong>


            <span>Laut letzter Erfassung</span>


          </div>


          <div class="status-card">


            <span>Besetzte Stellen (IST)</span>


            <strong id="statIst" class="value">0</strong>


            <span>Aktueller Stand</span>


          </div>


          <div class="status-card">


            <span>Delta Soll/Ist</span>


            <strong id="statDelta" class="value">0</strong>


            <span>Abweichung</span>


          </div>


        </section>





        <section class="card actions-card">


          <div class="btn-group">


            <button class="btn primary" id="saveBtn" type="button">Speichern</button>


            <button class="btn secondary" id="resetBtn" type="button">Zur&uuml;cksetzen</button>


            <button class="btn link" id="clusterBack" type="button">Zur &Uuml;bersicht</button>


          </div>


          <span class="muted info">Die Angaben werden fÃ¼r den Standort in SharePoint gespeichert (lokaler Speicher als Fallback).</span>


        </section>





        <section class="card table-card">


          <div class="table-wrap">


            <table id="master">


              <thead>


                <tr>


                  <th>Nr.</th>


                  <th>Bezeichnung des Funktionsdienstes</th>


                  <th>Mitarbeitende SOLL in VK</th>


                  <th>Mitarbeitende IST in VK</th>


                  <th>R&auml;ume / S&auml;le</th>


                  <th>Sono-Raum</th>


                  <th>Sonderarbeitsplatz (z. B. Schleuse)</th>


                  <th>Rufbereitschaft</th>


                  <th>3-j&auml;hrig Examinierte</th>


                  <th>1-j&auml;hrig Examinierte</th>


                  <th>MFA/ATA/OTA im Einsatz</th>


                  <th>Delta Soll/Ist</th>


                  <th>Arbeitnehmer&uuml;berlassung im Einsatz</th>


                </tr>


              </thead>


              <tbody id="tbody"></tbody>


              <tfoot>


                <tr>


                  <td colspan="2">Summe</td>


                  <td id="sumSOLL">0</td>


                  <td id="sumIST">0</td>


                  <td id="sumRaeume">0</td>


                  <td></td>


                  <td></td>


                  <td></td>


                  <td id="sum3j">0</td>


                  <td id="sum1j">0</td>


                  <td id="sumMFA">0</td>


                  <td id="sumDelta">0</td>


                  <td></td>


                </tr>


              </tfoot>


            </table>


          </div>


        </section>





        <footer>


          CliniCon &ndash; GFO Kliniken Verbund


        </footer>


      </main>


    </div>


  </div>


<script>


        const CLUSTERS = [


      { code: "BRU", name: "GFO Klinik Bruehl", members: ["BRU"] },


      { code: "ENG", name: "GFO Klinik Engelskirchen", members: ["ENG"] },


      { code: "GKB", name: "GFO Kliniken Bonn", members: ["GKB","BEU","BON"] },


      { code: "GKM", name: "GFO Kliniken Mettmann-Sued", members: ["GKM","HIL","LAN"] },


      { code: "GKN", name: "GFO Kliniken Niederrhein", members: ["GKN","DIN","DUI","MOE","RHE"] },


      { code: "GKRB", name: "GFO Kliniken Rhein-Berg", members: ["GKRB","BER"] },


      { code: "GKS", name: "GFO Kliniken Suedwestfalen", members: ["GKS","LEN","OLP"] },


      { code: "GKT", name: "GFO Kliniken Troisdorf", members: ["GKT","SIE","TRO"] },


      { code: "WIS", name: "GFO Klinik Wissen", members: ["WIS"] }


    ];





    const SITES = {


      BRU: "[BRU] GFO Klinik Bruehl",


      ENG: "[ENG] GFO Klinik Engelskirchen",


      GKB: "[GKB] GFO Kliniken Bonn",


      BEU: "[BEU] St. Josef Hospital Beuel",


      BON: "[BON] St. Marien Hospital Bonn",


      GKM: "[GKM] GFO Kliniken Mettmann-Sued",


      HIL: "[HIL] St. Josef Krankenhaus Hilden",


      LAN: "[LAN] St. Martinus Krankenhaus Langenfeld",


      GKN: "[GKN] GFO Kliniken Niederrhein",


      DIN: "[DIN] St. Vinzenz-Hospital Dinslaken",


      DUI: "[DUI] St. Camillus Duisburg",


      MOE: "[MOE] St. Josef Krankenhaus Moers",


      RHE: "[RHE] St. Nikolaus Rheinberg",


      GKRB: "[GKRB] GFO Kliniken Rhein-Berg",


      BER: "[BER] Marien-Krankenhaus Bergisch Gladbach",


      GKS: "[GKS] GFO Kliniken Suedwestfalen",


      LEN: "[LEN] St. Josef Hospital",


      OLP: "[OLP] St. Martinus Hospital",


      GKT: "[GKT] GFO Kliniken Troisdorf",


      SIE: "[SIE] St. Johannes Krankenhaus Sieglar",


      TRO: "[TRO] St. Josef Hospital Troisdorf",


      WIS: "[WIS] GFO Klinik Wissen"


    };





    const SITE_META = {


      BRU: { address: "Bruehl (Adresse folgt)" },


      ENG: { address: "Engelskirchen (Adresse folgt)" },


      GKB: { address: "Bonn (Adresse folgt)" },


      BEU: { address: "Beuel (Adresse folgt)" },


      BON: { address: "Bonn (Adresse folgt)" },


      GKM: { address: "Mettmann-Sued (Adresse folgt)" },


      HIL: { address: "Hilden (Adresse folgt)" },


      LAN: { address: "Langenfeld (Adresse folgt)" },


      GKN: { address: "Niederrhein (Adresse folgt)" },


      DIN: { address: "Dinslaken (Adresse folgt)" },


      DUI: { address: "Duisburg (Adresse folgt)" },


      MOE: { address: "Moers (Adresse folgt)" },


      RHE: { address: "Rheinberg (Adresse folgt)" },


      GKRB: { address: "Rhein-Berg (Adresse folgt)" },


      BER: { address: "Bergisch Gladbach (Adresse folgt)" },


      GKS: { address: "Suedwestfalen (Adresse folgt)" },


      LEN: { address: "Lennestadt (Adresse folgt)" },


      OLP: { address: "Olpe (Adresse folgt)" },


      GKT: { address: "Troisdorf (Adresse folgt)" },


      SIE: { address: "Sieglar (Adresse folgt)" },


      TRO: { address: "Troisdorf (Adresse folgt)" },


      WIS: { address: "Wissen (Adresse folgt)" }


    };





    const SERVICES = [


      { nr: 1,  name: "OP-Dienst (zentraler oder dezentraler OP)" },


      { nr: 2,  name: "AnÃ¤sthesiedienst" },


      { nr: 3,  name: "Endoskopie" },


      { nr: 4,  name: "Herzkatheterlabor" },


      { nr: 5,  name: "Notaufnahme (ZNA, interdisziplinÃ¤r)" },


      { nr: 6,  name: "InterdisziplinÃ¤re Aufnahmeeinheit (IAE / AUE)" },


      { nr: 7,  name: "Ambulantes OP-Zentrum (AOZ)" },


      { nr: 8,  name: "Zentrale Sterilgutversorgungsabteilung (AEMP)" },


      { nr: 9,  name: "Radiologie / CT / MRT / Angio" },


      { nr: 10, name: "Funktionsdiagnostik (z. B. EEG, EKG, Lungenfunktion)" },


      { nr: 11, name: "Dialyse" },


      { nr: 12, name: "Ambulanz / Spezialambulanzen" },


      { nr: 13, name: "Schmerzambulanz / Schmerztherapie" },


      { nr: 14, name: "InterdisziplinÃ¤re Tagesklinik" },


      { nr: 15, name: "Zentrale Patientenlogistik (wenn pflegerisch organisiert)" },


      { nr: 16, name: "Funktionsdienst GynÃ¤kologie (z. B. KreiÃŸsaalhilfe)" }


    ];





    const query = new URLSearchParams(window.location.search);


    const SITE_CODE = (query.get("site") || "").toUpperCase();


    const SITE_LABEL = SITES[SITE_CODE] || (SITE_CODE ? `[${SITE_CODE}]` : "");


    const SITE_NAME = SITE_LABEL ? SITE_LABEL.replace(/^\[[^\]]+\]\s*/, "") : (SITE_CODE || "Unbekannter Standort");


    const SITE_DISPLAY = SITE_LABEL || SITE_NAME;


    const STORAGE_KEY = `cliniCon_standort_${SITE_CODE || "UNKNOWN"}`;





    // ------------------------------------------------------------------------------------


    // SharePoint integration settings and helper functions


    // ------------------------------------------------------------------------------------


    // Name of the SharePoint list that stores the functional service data. Adjust to


    // match the actual list title. Based on the user's provided link, the list


    // appears to be called 'Datenstze' (without diacritics).


    const SP_LIST = "Datenstze";


    // Base path of your SharePoint site. Leave empty if this HTML page is hosted


    // on the same site where the list exists (recommended). For example,


    // '/personal/maarten_koomen_campus_hamburger-fh_de' if your page is stored in


    // another site collection.


    const SP_BASE = "";





    /**


     * Fetch a form digest value required for POST / MERGE operations on


     * SharePoint lists. A digest expires after a short time, so call


     * spDigest() immediately before performing write operations.


     */


    async function spDigest() {


      const r = await fetch(`${SP_BASE}/_api/contextinfo`, {


        method: "POST",


        headers: { "Accept": "application/json;odata=nometadata" },


        credentials: "include"


      });


      if (!r.ok) {


        const text = await r.text().catch(() => r.statusText);


        throw new Error(`contextinfo error ${r.status}: ${text}`);


      }


      const j = await r.json();


      return j.FormDigestValue;


    }





    /**


     * Retrieve list items for this app from SharePoint. Accepts an optional


     * OData filter string. Returns an object with a 'value' property


     * containing an array of items. The Accept header requests verbose


     * metadata to maximize compatibility.


     */


    async function spGetItems(filterOData) {


      const url = `${SP_BASE}/_api/web/lists/getbytitle('${SP_LIST}')/items?$select=Id,SiteCode,ServiceNr,ServiceName,Soll,Ist,Raeume,Sono,Sonder,Ruf,Ex3,Ex1,MFA,Anue${filterOData ? `&$filter=${filterOData}` : ""}`;


      const r = await fetch(url, {


        headers: { "Accept": "application/json;odata=verbose" },


        credentials: "include"


      });


      if (!r.ok) {


        const text = await r.text().catch(() => r.statusText);


        throw new Error(`GET failed ${r.status}: ${text}`);


      }


      const data = await r.json();


      // Normalize both verbose and nometadata formats to data.value array


      if (data.d && data.d.results) return { value: data.d.results };


      return data;


    }





    /**


     * Create a new list item in SharePoint using the given digest and payload.


     * The payload should include all relevant fields.


     */


    async function spCreateItem(digest, payload) {


      const r = await fetch(`${SP_BASE}/_api/web/lists/getbytitle('${SP_LIST}')/items`, {


        method: "POST",


        headers: {


          "Accept": "application/json;odata=verbose",


          "Content-Type": "application/json;odata=verbose",


          "X-RequestDigest": digest


        },


        credentials: "include",


        body: JSON.stringify(payload)


      });


      if (!r.ok) {


        const text = await r.text().catch(() => r.statusText);


        throw new Error(`Create failed ${r.status}: ${text}`);


      }


      return r.json();


    }





    /**


     * Update an existing SharePoint list item by ID. Uses MERGE semantics so


     * unspecified fields remain unchanged.


     */


    async function spUpdateItem(digest, id, payload) {


      const r = await fetch(`${SP_BASE}/_api/web/lists/getbytitle('${SP_LIST}')/items(${id})`, {


        method: "POST",


        headers: {


          "Accept": "application/json;odata=verbose",


          "Content-Type": "application/json;odata=verbose",


          "IF-Match": "*",


          "X-HTTP-Method": "MERGE",


          "X-RequestDigest": digest


        },


        credentials: "include",


        body: JSON.stringify(payload)


      });


      if (!r.ok) {


        const text = await r.text().catch(() => r.statusText);


        throw new Error(`Update failed ${r.status}: ${text}`);


      }


    }





    /**


     * Convert a value to a number or null (used for numeric fields). Empty


     * strings or non-numeric values become null to avoid zeroing fields.


     */


    function toNum(v) {


      const n = parseInt(v, 10);


      return isNaN(n) ? null : n;


    }





    /**


     * Upsert a row into SharePoint. If an item exists for the given site code


     * and service number, update it; otherwise create a new item. The


     * function constructs a payload mapping our table fields to list fields.


     */


    async function spUpsertRow(digest, row, siteCode) {


      const filter = `SiteCode eq '${siteCode}' and ServiceNr eq ${row.nr}`;


      const existing = await spGetItems(filter);


      const payload = {


        Title: `${siteCode}-${row.nr}`,


        SiteCode: siteCode,


        ServiceNr: row.nr,


        ServiceName: row.name,


        Soll: toNum(row.soll),


        Ist: toNum(row.ist),


        Raeume: toNum(row.raeume),


        Sono: toNum(row.sono),


        Sonder: row.sonder || "",


        Ruf: row.ruf || "",


        Ex3: toNum(row.ex3),


        Ex1: toNum(row.ex1),


        MFA: toNum(row.mfa),


        Anue: row.anue || ""


      };


      if (existing.value && existing.value.length) {


        await spUpdateItem(digest, existing.value[0].Id, payload);


      } else {


        await spCreateItem(digest, payload);


      }


    }


    const siteCodeEl = document.getElementById("siteCode");


    const siteTitleEl = document.getElementById("siteTitle");


    const siteIntroEl = document.getElementById("siteIntro");


    const clusterLinkEl = document.getElementById("clusterLink");


    const clusterNameEl = document.getElementById("clusterName");


    const siteAddressEl = document.getElementById("siteAddress");


    const statSollEl = document.getElementById("statSoll");


    const statIstEl = document.getElementById("statIst");


    const statDeltaEl = document.getElementById("statDelta");


    const clusterBackBtn = document.getElementById("clusterBack");





    const clusterInfo = CLUSTERS.find(cluster => cluster.members.includes(SITE_CODE)) || null;





    if (siteCodeEl) siteCodeEl.textContent = SITE_CODE || "N/A";


    if (siteTitleEl) siteTitleEl.textContent = SITE_NAME;


    if (siteIntroEl) siteIntroEl.textContent = `Mastertabelle fuer ${SITE_NAME}. Pflegen Sie hier alle Funktionsdienste und Stellenwerte des Standorts.`;


    if (siteAddressEl) siteAddressEl.textContent = (SITE_META[SITE_CODE]?.address) || "Adresse wird ergänzt.";





    if (clusterLinkEl && clusterNameEl) {


      if (clusterInfo) {


        clusterLinkEl.href = `1_klinikverbund.html?cluster=${clusterInfo.code}`;


        clusterNameEl.textContent = clusterInfo.name;


      } else {


        clusterLinkEl.href = "1_klinikverbund.html";


        clusterNameEl.textContent = "Zur Klinikverbund-Uebersicht";


      }


    }





    if (clusterBackBtn) {


      clusterBackBtn.addEventListener("click", () => {


        const target = clusterInfo ? `1_klinikverbund.html?cluster=${clusterInfo.code}` : "1_klinikverbund.html";


        window.location.href = target;


      });


    }


    const DEFAULT_ROWS = SERVICES.map(service => ({


      nr: service.nr,


      name: service.name,


      soll: "",


      ist: "",


      raeume: "",


      sono: "",


      sonder: "",


      ruf: "",


      ex3: "",


      ex1: "",


      mfa: "",


      anue: ""


    }));





    const tbody = document.getElementById("tbody");





    const numInput = (value = "") => {


      const input = document.createElement("input");


      input.type = "number";


      input.step = "1";


      input.min = "0";


      input.value = value;


      input.addEventListener("input", () => {


        const cleaned = input.value.replace(/[^0-9]/g, "");


        if (cleaned !== input.value) input.value = cleaned;


        recalc();


      });


      return input;


    };





    const textInput = (value = "") => {


      const input = document.createElement("input");


      input.type = "text";


      input.value = value;


      input.readOnly = true;


      input.classList.add("readonly");


      return input;


    };





    const makeSelect = (options, current = "") => {


      const select = document.createElement("select");


      options.forEach(opt => {


        const option = document.createElement("option");


        option.value = opt;


        option.textContent = opt;


        if (opt === current) option.selected = true;


        select.appendChild(option);


      });


      return select;


    };





    const stored = () => {


      try {


        const raw = localStorage.getItem(STORAGE_KEY);


        if (!raw) return null;


        return JSON.parse(raw);


      } catch (error) {


        console.error("Fehler beim Laden aus localStorage", error);


        return null;


      }


    };





    const buildTable = (rows) => {


      tbody.innerHTML = "";


      rows.forEach(row => {


        const tr = document.createElement("tr");





        const tdNr = document.createElement("td");


        tdNr.textContent = row.nr;


        tr.appendChild(tdNr);





        const tdName = document.createElement("td");


        const nameField = textInput(row.name);


        tdName.classList.add("name-cell");


        tdName.appendChild(nameField);


        tr.appendChild(tdName);





        const tdSoll = document.createElement("td"); const inputSoll = numInput(row.soll); inputSoll.step = "1"; tdSoll.appendChild(inputSoll); tr.appendChild(tdSoll);


        const tdIst  = document.createElement("td"); const inputIst  = numInput(row.ist);  inputIst.step = "1";  tdIst.appendChild(inputIst);  tr.appendChild(tdIst);


        const tdRaeume = document.createElement("td"); const inputRaeume = numInput(row.raeume); inputRaeume.step = "1"; tdRaeume.appendChild(inputRaeume); tr.appendChild(tdRaeume);


        const tdSono = document.createElement("td"); const inputSono = numInput(row.sono); inputSono.step = "1"; tdSono.appendChild(inputSono); tr.appendChild(tdSono);





        const tdSonder = document.createElement("td"); const inputSonder = textInput(row.sonder); tdSonder.appendChild(inputSonder); tr.appendChild(tdSonder);


        const tdRuf = document.createElement("td"); const selectRuf = makeSelect(["", "Ja", "Nein"], row.ruf); tdRuf.appendChild(selectRuf); tr.appendChild(tdRuf);





        const tdEx3 = document.createElement("td"); const inputEx3 = numInput(row.ex3); inputEx3.step = "1"; tdEx3.appendChild(inputEx3); tr.appendChild(tdEx3);


        const tdEx1 = document.createElement("td"); const inputEx1 = numInput(row.ex1); inputEx1.step = "1"; tdEx1.appendChild(inputEx1); tr.appendChild(tdEx1);


        const tdMfa = document.createElement("td"); const inputMfa = numInput(row.mfa); inputMfa.step = "1"; tdMfa.appendChild(inputMfa); tr.appendChild(tdMfa);





        const tdDelta = document.createElement("td"); const deltaSpan = document.createElement("span"); tdDelta.appendChild(deltaSpan); tr.appendChild(tdDelta);





        const tdAnue = document.createElement("td"); const selectAnue = makeSelect(["", "Ja", "Nein"], row.anue); tdAnue.appendChild(selectAnue); tr.appendChild(tdAnue);





        tr._refs = { inputSoll, inputIst, deltaSpan, inputRaeume, inputEx3, inputEx1, inputMfa };


        tbody.appendChild(tr);


      });


      recalc();


    };





    const recalc = () => {


      let sumSoll = 0;


      let sumIst = 0;


      let sumRaeume = 0;


      let sum3 = 0;


      let sum1 = 0;


      let sumMfa = 0;


      let sumDelta = 0;





      [...tbody.rows].forEach(tr => {


        const { inputSoll, inputIst, deltaSpan, inputRaeume, inputEx3, inputEx1, inputMfa } = tr._refs;


        const soll = parseInt(inputSoll.value) || 0;


        const ist = parseInt(inputIst.value) || 0;


        const delta = ist - soll;


        deltaSpan.textContent = delta.toLocaleString("de-DE");


        deltaSpan.className = delta === 0 ? "" : (delta > 0 ? "pos" : "neg");





        sumSoll += soll;


        sumIst += ist;


        sumDelta += delta;


        sumRaeume += parseInt(inputRaeume.value) || 0;


        sum3 += parseInt(inputEx3.value) || 0;


        sum1 += parseInt(inputEx1.value) || 0;


        sumMfa += parseInt(inputMfa.value) || 0;


      });





      if (statSollEl) statSollEl.textContent = sumSoll.toLocaleString("de-DE");


      if (statIstEl) statIstEl.textContent = sumIst.toLocaleString("de-DE");


      if (statDeltaEl) {


        const deltaFormatted = sumDelta === 0 ? "0" : `${sumDelta > 0 ? "+" : ""}${sumDelta.toLocaleString("de-DE")}`;


        statDeltaEl.textContent = deltaFormatted;


        statDeltaEl.classList.remove("positive","negative");


        if (sumDelta > 0) statDeltaEl.classList.add("positive");


        if (sumDelta < 0) statDeltaEl.classList.add("negative");


      }      document.getElementById("sumSOLL").textContent = sumSoll.toLocaleString("de-DE");


      document.getElementById("sumIST").textContent = sumIst.toLocaleString("de-DE");


      document.getElementById("sumRaeume").textContent = sumRaeume.toLocaleString("de-DE");


      document.getElementById("sum3j").textContent = sum3.toLocaleString("de-DE");


      document.getElementById("sum1j").textContent = sum1.toLocaleString("de-DE");


      document.getElementById("sumMFA").textContent = sumMfa.toLocaleString("de-DE");


      document.getElementById("sumDelta").textContent = sumDelta.toLocaleString("de-DE");


    };





    /**


     * Load existing rows from SharePoint for a given site. Returns an array


     * of row objects matching the SERVICES order or null if no data is found.


     * If the call fails, the error propagates to the caller.


     */


    async function loadFromSharePoint(siteCode) {


      const data = await spGetItems(`SiteCode eq '${siteCode}'`);


      if (!data.value || !data.value.length) return null;


      const byNr = new Map(data.value.map(it => [it.ServiceNr, it]));


      return SERVICES.map(s => {


        const it = byNr.get(s.nr);


        return {


          nr: s.nr,


          name: s.name,


          soll: it?.Soll ?? "",


          ist: it?.Ist ?? "",


          raeume: it?.Raeume ?? "",


          sono: it?.Sono ?? "",


          sonder: it?.Sonder ?? "",


          ruf: it?.Ruf ?? "",


          ex3: it?.Ex3 ?? "",


          ex1: it?.Ex1 ?? "",


          mfa: it?.MFA ?? "",


          anue: it?.Anue ?? ""


        };


      });


    }





    const collectRows = () => {


      const rows = [];


      [...tbody.rows].forEach(tr => {


        const cells = tr.cells;


        rows.push({


          nr: parseInt(cells[0].textContent.trim(), 10),


          name: cells[1].querySelector("input").value,


          soll: cells[2].querySelector("input").value,


          ist: cells[3].querySelector("input").value,


          raeume: cells[4].querySelector("input").value,


          sono: cells[5].querySelector("input").value,


          sonder: cells[6].querySelector("input").value,


          ruf: cells[7].querySelector("select").value,


          ex3: cells[8].querySelector("input").value,


          ex1: cells[9].querySelector("input").value,


          mfa: cells[10].querySelector("input").value,


          anue: cells[12].querySelector("select").value


        });


      });


      return rows;


    };





    document.getElementById("saveBtn").addEventListener("click", async () => {


      if (!SITE_CODE) {


        alert("Kein Standort-Code uebergeben.");


        return;


      }


      const rows = collectRows();


      try {


        const digest = await spDigest();


        // Save to SharePoint in manageable chunks


        const chunkSize = 8;


        for (let i = 0; i < rows.length; i += chunkSize) {


          const slice = rows.slice(i, i + chunkSize);


          await Promise.all(slice.map(r => spUpsertRow(digest, r, SITE_CODE)));


        }


        // Also update localStorage as a fallback


        localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));


        alert(`In SharePoint gespeichert fÃ¼r ${SITE_DISPLAY || SITE_CODE}.`);


      } catch (err) {


        console.error(err);


        // If SharePoint call fails, attempt to save to local storage only


        try {


          localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));


          alert(`Offline gespeichert fÃ¼r ${SITE_DISPLAY || SITE_CODE}, SharePoint-Speicherung fehlgeschlagen.`);


        } catch (error) {


          console.error(error);


          alert("Speichern leider nicht mÃ¶glich.");


        }


      }


    });





    document.getElementById("resetBtn").addEventListener("click", () => {


      if (!SITE_CODE) {


        alert("Kein Standort-Code uebergeben.");


        return;


      }


      if (!confirm("Wirklich zuruecksetzen fuer diesen Standort?")) return;


      localStorage.removeItem(STORAGE_KEY);


      buildTable(DEFAULT_ROWS);


    });





    // On page load, attempt to load data from SharePoint first. If nothing is found,


    // fall back to localStorage and finally to the default empty table. Use an


    // immediately invoked async function since top-level await is not supported.


    (async () => {


      let rows = null;


      if (SITE_CODE) {


        try {


          rows = await loadFromSharePoint(SITE_CODE);


        } catch (e) {


          console.warn("Fehler beim Laden aus SharePoint:", e);


        }


      }


      const localData = stored();


      buildTable(rows || localData || DEFAULT_ROWS);


    })();


  </script>


</body>


</html>





































































