<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stellenplan</title>
  <link rel="stylesheet" href="../../../../style.css" />
  <style>
    :root{
      --accent:#1f4b82; --accent-strong:#12355c; --line:#dbe3ec; --muted:#6b7280;
      --header:#edf3f7; --row:#f9fbff; --hover:#f1f5f9; --card:#fff; --shadow:0 12px 30px rgba(15,23,42,.14);
    }
    body{margin:0; font-family:var(--font-base); font-size:15px; background:#eef3f7; color:#0f172a;}
    main{padding:20px; display:flex; flex-direction:column; gap:16px; width:100%; max-width:100%; margin:0 auto;}
    .card{box-shadow:var(--shadow); border:1px solid rgba(15,23,42,.06); background:var(--card);}    .top{display:flex; flex-direction:column; gap:10px; padding:16px;}
    .header-row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; padding-bottom:8px; border-bottom:1px solid var(--line);}    .hero-title{display:flex; flex-direction:column; gap:6px;}    .pill{display:inline-flex; gap:8px; padding:7px 12px; border-radius:12px; background:linear-gradient(135deg, #1f4b82, #12355c); color:#fff; font-weight:700;}    h1{margin:0;}    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin-top:6px; padding-top:6px;}    .controls label{display:flex; flex-direction:column; gap:4px; font-weight:700; color:#0f172a;}    .controls select,.controls input{padding:9px 11px; border:1px solid var(--line); border-radius:12px; font:inherit; background:#fff; box-shadow:0 7px 18px rgba(15,23,42,0.05);}    .controls button{border:1px solid transparent; background:linear-gradient(135deg, #16a34a, #0f9d58); padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:700; color:#fff; transition:.15s ease all; box-shadow:0 9px 20px rgba(18,53,92,.16); margin-top:6px;}    .controls .btn-save{background:linear-gradient(135deg, #1fa2ff, #2563eb); box-shadow:0 9px 20px rgba(37,99,235,.2);}    .controls button:hover{box-shadow:0 12px 28px rgba(18,53,92,.2); transform:translateY(-1px);} .controls button:active{transform:translateY(0);}    .summary{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;}    .tile{padding:14px 16px; border:1px solid rgba(148,163,184,.4); border-radius:14px; background:linear-gradient(145deg, rgba(255,255,255,0.9), rgba(241,245,249,0.95)); box-shadow:var(--shadow); display:grid; gap:6px;}    .tile span{color:var(--muted);} .tile strong{font-size:1.3rem;}    .table-wrap{overflow:auto; border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:var(--shadow); scrollbar-width:none;}    .table-wrap::-webkit-scrollbar{display:none;}    table{width:100%; border-collapse:collapse; font-size:0.94rem;}    th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle;}    th{background:var(--header); color:#0f172a; position:sticky; top:0; z-index:2; font-size:0.9rem; border-right:1px solid #d7e0eb; font-weight:800;}    th:last-child{border-right:none;} th:first-child, td:first-child{position:sticky; left:0; background:#fff; z-index:3; border-right:1px solid #d7e0eb;}    tr:nth-child(even) td{background:#f9fbff;} tr:hover td{background:var(--hover);} .sort-indicator{font-size:0.8rem; color:#6b7280; margin-left:6px;}    .name-input,.vk-input{width:100%; padding:8px 8px; border:1px solid var(--line); border-radius:8px; font:inherit; text-align:center; background:#fff; transition:.15s ease all;} .name-input{text-align:left;} .name-input:focus,.vk-input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(31,162,255,.18);} .vk-input::-webkit-outer-spin-button,.vk-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;} .vk-input{-moz-appearance:textfield;}    td.actions-cell, th.actions-col{vertical-align:middle; text-align:center; padding:6px 8px; min-width:140px;} .actions-cell .action-buttons{display:flex; gap:8px; justify-content:center; align-items:center;} .icon-btn{width:38px; height:38px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; box-shadow:0 4px 10px rgba(15,23,42,0.08); display:flex; align-items:center; justify-content:center;} .icon-btn:hover{background:#f1f5f9;} th.actions-col, td.actions-cell{text-align:center;}    .totals-row td{font-weight:700; background:#f8fafc;} .spacer-row td{background:#f1f5f9;}    .pnr-cell input{background:#eef2ff; border-color:#c7d2fe;}    .row-muted td{background:linear-gradient(90deg,#e2e8f0,#f8fafc); color:#334155; box-shadow:inset 4px 0 0 #cbd5e1;}    .row-muted td:first-child{background:linear-gradient(90deg,#cbd5e1,#e2e8f0); box-shadow:inset 6px 0 0 #0ea5e9; position:sticky; left:0;}    .row-muted td:first-child::before{content:'Ausgeblendet'; position:absolute; top:6px; right:8px; background:#0ea5e9; color:#fff; padding:2px 10px; border-radius:10px; font-size:0.75rem; font-weight:800;}    .row-muted input{background:#e2e8f0; border-color:#cbd5e1; color:#334155;}    .action-menu{position:absolute; background:#fff; border:1px solid var(--line); box-shadow:0 12px 30px rgba(15,23,42,0.18); border-radius:10px; padding:6px 0; display:none; z-index:200; min-width:220px;}    .action-menu button{display:block; width:100%; padding:9px 14px; background:none; border:none; text-align:left; cursor:pointer; font:inherit; font-weight:700;}    .action-menu button:hover{background:#f1f5f9;}    th.month-col, td.month-col{min-width:68px; width:68px;}    .save-status{display:inline-block; padding:6px 10px; border-radius:10px; background:#ecfeff; color:#0f172a; border:1px solid #bae6fd; font-weight:600;} .save-status.error{background:#fef2f2; border-color:#fecdd3; color:#991b1b;}    .qual-badge{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#f8fafc; cursor:pointer; text-align:left; font-size:0.88rem; display:flex; justify-content:space-between; align-items:center;}    .qual-popover{position:absolute; background:#fff; border:1px solid var(--line); box-shadow:0 12px 30px rgba(15,23,42,0.16); border-radius:12px; padding:10px; display:none; z-index:190; width:240px; max-height:260px; overflow:auto;}    .qual-popover label{display:flex; align-items:center; gap:8px; font-size:0.88rem; padding:4px 2px;}    @media (max-width: 900px){th:nth-child(2), td:nth-child(2){left:100px;} th:first-child, td:first-child{min-width:100px;}}
  </style>
</head>
<body>
  <main>
    <section class="card top">
      <div class="header-row">
        <div class="hero-title">
          <div class="pill">Stellenplan</div>
          <h1>Planung &amp; Kontrolle</h1>
          <p style="margin:0; color:var(--muted);">VK-Werte pro Monat sichern; Jahr ueber Spaltensuffix (jan_YYYY ... dez_YYYY).</p>
        </div>
        <span id="saveStatus" class="save-status" aria-live="polite" style="display:none;"></span>
      </div>
      <div class="controls">
        <label style="min-width:200px;">Abteilung
          <select id="deptSelect"></select>
        </label>
        <label style="min-width:120px;">Jahr
          <input id="yearInput" type="number" min="2026" max="2099" />
        </label>
        <button id="btnAddRow" type="button">+ Mitarbeiter:in</button>
        <button id="btnAddExtra" type="button">+ Zusatzzeile</button>
        <button id="btnSaveDb" class="btn-save" type="button">Speichern (DB)</button>
      </div>
      <div class="summary">
        <div class="tile"><span>Summe (Jahr)</span><strong id="sumYear">0,0</strong></div>
        <div class="tile"><span>Durchschnitt / Monat</span><strong id="avgMonth">0,0</strong></div>
        <div class="tile"><span>Peak-Monat</span><strong id="peakMonth">-</strong></div>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table id="planTable">
          <thead>
            <tr>
              <th style="min-width:120px;" data-sort="pnr">Personalnummer <span class="sort-indicator" data-sort-ind="pnr"></span></th>
              <th style="min-width:200px;" data-sort="name">Mitarbeiter:in <span class="sort-indicator" data-sort-ind="name"></span></th>
              <th class="month-col">Jan</th><th class="month-col">Feb</th><th class="month-col">Mrz</th><th class="month-col">Apr</th><th class="month-col">Mai</th><th class="month-col">Jun</th>
              <th class="month-col">Jul</th><th class="month-col">Aug</th><th class="month-col">Sep</th><th class="month-col">Okt</th><th class="month-col">Nov</th><th class="month-col">Dez</th>
              <th>&Oslash; Monat</th>
              <th style="min-width:140px;">Qualifikation</th>
              <th class="actions-col">Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="totals-row">
              <td></td>
              <td>Summe Monat</td>
              <td data-sum-month="0">0,0</td><td data-sum-month="1">0,0</td><td data-sum-month="2">0,0</td><td data-sum-month="3">0,0</td><td data-sum-month="4">0,0</td><td data-sum-month="5">0,0</td><td data-sum-month="6">0,0</td><td data-sum-month="7">0,0</td><td data-sum-month="8">0,0</td><td data-sum-month="9">0,0</td><td data-sum-month="10">0,0</td><td data-sum-month="11">0,0</td>
              <td data-total-year>0,0</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="section-header">
        <h3 style="margin-top:0; padding:12px;">Zusatzgruppen (Schueler:innen, Azubis, MFA, ATA ...)</h3>
      </div>
      <div class="table-wrap">
        <table id="extrasTable">
          <thead>
            <tr>
              <th style="min-width:120px;" data-sort="pnr-ex">Personalnummer <span class="sort-indicator" data-sort-ind="pnr-ex"></span></th>
              <th style="min-width:200px;" data-sort="cat-ex">Kategorie <span class="sort-indicator" data-sort-ind="cat-ex"></span></th>
              <th class="month-col">Jan</th><th class="month-col">Feb</th><th class="month-col">Mrz</th><th class="month-col">Apr</th><th class="month-col">Mai</th><th class="month-col">Jun</th>
              <th class="month-col">Jul</th><th class="month-col">Aug</th><th class="month-col">Sep</th><th class="month-col">Okt</th><th class="month-col">Nov</th><th class="month-col">Dez</th>
              <th>&Oslash; Monat</th>
              <th style="min-width:140px;">Qualifikation</th>
              <th class="actions-col">Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr class="totals-row">
              <td></td>
              <td>Summe Zusatz</td>
              <td data-extra-month="0">0,0</td><td data-extra-month="1">0,0</td><td data-extra-month="2">0,0</td><td data-extra-month="3">0,0</td><td data-extra-month="4">0,0</td><td data-extra-month="5">0,0</td><td data-extra-month="6">0,0</td><td data-extra-month="7">0,0</td><td data-extra-month="8">0,0</td><td data-extra-month="9">0,0</td><td data-extra-month="10">0,0</td><td data-extra-month="11">0,0</td>
              <td data-total-extra>0,0</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="totals-row spacer-row">
              <td></td>
              <td>Abschluss (Haupt + Zusatz)</td>
              <td data-combined-month="0">0,0</td><td data-combined-month="1">0,0</td><td data-combined-month="2">0,0</td><td data-combined-month="3">0,0</td><td data-combined-month="4">0,0</td><td data-combined-month="5">0,0</td><td data-combined-month="6">0,0</td><td data-combined-month="7">0,0</td><td data-combined-month="8">0,0</td><td data-combined-month="9">0,0</td><td data-combined-month="10">0,0</td><td data-combined-month="11">0,0</td>
              <td data-total-combined>0,0</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="totals-row">
              <td></td>
              <td>Wirtschaftsplan (VK)</td>
              <td colspan="12" id="planRowNote" style="text-align:right; font-size:0.9rem; color:#475569;">-</td>
              <td data-plan-total>0,0</td>
              <td data-plan-delta>0,0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <div id="qualPopover" class="qual-popover"></div>
  <div id="actionMenu" class="action-menu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const STORAGE_KEY='clinicon_stellenplan_v5';
    const SUPABASE_URL_STORAGE='clinicon_supabase_url';
    const SUPABASE_KEY_STORAGE='clinicon_supabase_key';
    const MONTHS=['Jan','Feb','Mrz','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    const MONTH_KEYS=['jan','feb','mrz','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
    const YEAR_MIN=2026, YEAR_MAX=2099;
    const DEPARTMENTS=['Station 1','Station 2','Station 3','Station 4','Station 5','Station 6','Station 7','Endoskopie','OP','Sozialdienst','Pflegedienstleitung'];
    const QUAL_OPTIONS=[
      'Pflegefachkraft','Pflegefachassistenz','Notfallpflege','Anaesthesie/Intensiv','Hygiene','Praxisanleitung','OP','Endoskopie','Onkologie','Palliativ','Wundmanagement','Diabetes','Dialyse','Stroke Unit','Kardiologie','Geriatrie','Neonatologie','Psychiatrie','Schmerzmanagement','Pflegepaedagogik','Stationsleitung','Fachkraft Praev./Reha'
    ];

    const DEFAULT_SUPABASE_URL='https://fqilehnixnsujefyrdcy.supabase.co';
    const DEFAULT_SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaWxlaG5peG5zdWplZnlyZGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjIyNzUsImV4cCI6MjA3OTQ5ODI3NX0.Ml1J-YsID7_CXX7LbLZM4ayhWpV08FBSZc3rgVuwqt4';
    const SUPABASE_URL=(window.SUPABASE_URL||localStorage.getItem(SUPABASE_URL_STORAGE)||DEFAULT_SUPABASE_URL).trim();
    const SUPABASE_ANON_KEY=(window.SUPABASE_ANON_KEY||localStorage.getItem(SUPABASE_KEY_STORAGE)||DEFAULT_SUPABASE_KEY).trim();
    const supabaseClient=(typeof window.supabase!=='undefined'&&SUPABASE_URL&&SUPABASE_ANON_KEY)?window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY):null;
    if(!localStorage.getItem(SUPABASE_URL_STORAGE)&&SUPABASE_URL){try{localStorage.setItem(SUPABASE_URL_STORAGE,SUPABASE_URL);}catch(e){}}
    if(!localStorage.getItem(SUPABASE_KEY_STORAGE)&&SUPABASE_ANON_KEY){try{localStorage.setItem(SUPABASE_KEY_STORAGE,SUPABASE_ANON_KEY);}catch(e){}}

    const SITE_LABEL=(sessionStorage.getItem('cliniconSite')||'').trim();
    const SITE_CODE=SITE_LABEL.toLowerCase().replace(/[^a-z0-9_]/g,'');
    const HAS_SITE=Boolean(SITE_CODE);
    const TABLE_EMP_BASE='stellenplan_employees';
    const workerDefault='https://divine-disk-6cb5.maarten-koomen.workers.dev';
    const API_BASE=(window.CLINICON_API_BASE||localStorage.getItem('clinicon_api_base')||workerDefault).trim();
    const PARAM_TABLE=SITE_CODE?`parameter_${SITE_CODE}`:null;

    const ICON_TRASH='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6v-1a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v1"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"/></svg>';
    const ICON_MENU='&#8942;';

    const els={
      deptSelect:document.getElementById('deptSelect'),
      yearInput:document.getElementById('yearInput'),
      tbody:document.querySelector('#planTable tbody'),
      extrasTbody:document.querySelector('#extrasTable tbody'),
      sumYear:document.getElementById('sumYear'),
      avgMonth:document.getElementById('avgMonth'),
      peakMonth:document.getElementById('peakMonth'),
      planTotalCell:document.querySelector('[data-plan-total]'),
      planDeltaCell:document.querySelector('[data-plan-delta]'),
      planRowNote:document.getElementById('planRowNote'),
      actionMenu:document.getElementById('actionMenu'),
      qualPopover:document.getElementById('qualPopover'),
      saveStatus:document.getElementById('saveStatus'),
    };

    const state={dept:DEPARTMENTS[0],year:Math.max(YEAR_MIN,Math.min(YEAR_MAX,new Date().getFullYear())),data:{},sortKey:null,sortDir:'asc'};
    let planVK=0;
    let combinedAvg=0;
    let lastFocused=null;
    let actionTarget=null;

    const dbMonthCols=(year)=>MONTH_KEYS.map(k=>`${k}_${year}`);
    const tableName=(base)=>SITE_CODE?`${base}_${SITE_CODE}`:base;
    const fmt=(n)=>Number(n||0).toFixed(2).replace('.',',');

    function setSaveStatus(msg,err=false){ if(!els.saveStatus) return; els.saveStatus.style.display=msg?'inline-block':'none'; els.saveStatus.textContent=msg||''; els.saveStatus.classList.toggle('error',Boolean(err)); }
    function setLoadStatus(msg){ setSaveStatus(msg||'',true); }

    function ensureDefaults(plan){
      plan.employees.forEach(emp=>{
        if(emp.personalNumber===undefined) emp.personalNumber='';
        if(emp.include===undefined) emp.include=true;
        if(emp.qual===undefined) emp.qual='';
        if(emp.hiddenRow===undefined) emp.hiddenRow=false;
        if(emp.include===false && !emp.hiddenRow) emp.hiddenRow=true;
        if(emp.hiddenRow) emp.include=false;
        emp.values=Array.isArray(emp.values)?emp.values.map(v=>Number(v)||0):Array(12).fill(0);
      });
      plan.extras.forEach(ex=>{
        if(ex.personalNumber===undefined) ex.personalNumber='';
        if(ex.include===undefined) ex.include=true;
        if(ex.qual===undefined) ex.qual='';
        if(ex.hiddenRow===undefined) ex.hiddenRow=false;
        if(ex.include===false && !ex.hiddenRow) ex.hiddenRow=true;
        if(ex.hiddenRow) ex.include=false;
        ex.values=Array.isArray(ex.values)?ex.values.map(v=>Number(v)||0):Array(12).fill(0);
      });
    }

    function getCurrentPlan(){
      const key=`${state.dept}-${state.year}`;
      if(!state.data[key]){
        state.data[key]={
          employees:[
            {id:crypto.randomUUID(),personalNumber:'',name:'Mitarbeiter:in 1',include:true,qual:'',values:Array(12).fill(0)},
            {id:crypto.randomUUID(),personalNumber:'',name:'Mitarbeiter:in 2',include:true,qual:'',values:Array(12).fill(0)}
          ],
          extras:[
            {id:crypto.randomUUID(),personalNumber:'',category:'Schueler:in',include:true,qual:'',values:Array(12).fill(0)},
            {id:crypto.randomUUID(),personalNumber:'',category:'Azubi',include:true,qual:'',values:Array(12).fill(0)},
            {id:crypto.randomUUID(),personalNumber:'',category:'MFA/ATA',include:true,qual:'',values:Array(12).fill(0)}
          ]
        };
      }
      ensureDefaults(state.data[key]);
      return state.data[key];
    }

    function persistPersonalNumber(pn,isExtra){ const base=(pn||'').toString().trim(); if(!base) return ''; if(isExtra) return base.startsWith('EX-')?base:`EX-${base}`; return base.replace(/^EX-/,''); }
    function displayPersonalNumber(pn){ return (pn||'').toString().replace(/^EX-/,''); }
    function isExtraRow(row){ const pn=(row.personal_number||row.personalNumber||'').toString(); return pn.startsWith('EX-'); }

    async function loadPlanValue(){
      if(!supabaseClient||!PARAM_TABLE){ planVK=0; updatePlanRow(); return; }
      try{
        const { data, error } = await supabaseClient.from(PARAM_TABLE).select('wirtschaftsplan_vk').eq('dept', state.dept).eq('year', state.year).maybeSingle();
        if(error) throw error;
        planVK=Number(data?.wirtschaftsplan_vk)||0;
      }catch(err){ planVK=0; }
      updatePlanRow();
    }
    function updatePlanRow(){
      if(els.planTotalCell) els.planTotalCell.textContent=fmt(planVK);
      if(els.planDeltaCell) els.planDeltaCell.textContent=fmt(planVK - combinedAvg);
      if(els.planRowNote) els.planRowNote.textContent=`Wirtschaftsplan VK (${state.dept}, ${state.year})`;
    }

    async function fetchRemotePlan(){
      if(!supabaseClient||!HAS_SITE) return null;
      const cols=dbMonthCols(state.year);
      const selectCols=['id','dept','personal_number','name','qual','include',...cols].join(',');
      try{
        const { data, error } = await supabaseClient.from(tableName(TABLE_EMP_BASE)).select(selectCols).eq('dept', state.dept);
        if(error) throw error;
        const employees=[], extras=[];
        (data||[]).forEach(emp=>{
          const vals=cols.map(c=>Number(emp[c]||0));
          const item={id:emp.id,personalNumber:persistPersonalNumber(emp.personal_number||'',isExtraRow(emp)),name:emp.name,qual:emp.qual||'',include:emp.include!==false,hiddenRow:emp.include===false,values:vals};
          if(isExtraRow(emp)) extras.push({...item,category:emp.name||item.personalNumber||'Zusatz'});
          else employees.push(item);
        });
        return {employees,extras};
      }catch(err){
        setLoadStatus(err.message||'Laden fehlgeschlagen');
        return null;
      }
    }

    async function syncRemotePlan(){
      if(!supabaseClient||!HAS_SITE) return;
      const cols=dbMonthCols(state.year);
      const plan=getCurrentPlan();
      const rows=[];
      plan.employees.forEach(emp=>{
        const row={id:emp.id,dept:state.dept,personal_number:persistPersonalNumber(emp.personalNumber||'',false),name:emp.name,qual:emp.qual||'',include:emp.include!==false};
        cols.forEach((c,idx)=>row[c]=Number(emp.values[idx])||0);
        rows.push(row);
      });
      plan.extras.forEach(ex=>{
        const row={id:ex.id,dept:state.dept,personal_number:persistPersonalNumber(ex.personalNumber||'',true),name:ex.category||ex.name||persistPersonalNumber(ex.personalNumber||'',true),qual:ex.qual||'',include:ex.include!==false};
        cols.forEach((c,idx)=>row[c]=Number(ex.values[idx])||0);
        rows.push(row);
      });
      const up=await supabaseClient.from(tableName(TABLE_EMP_BASE)).upsert(rows,{onConflict:'id'});
      if(up.error) throw new Error(up.error.message);
    }

    function saveStorage(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }catch(e){} }
    function loadStorage(){ try{ state.data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); }catch(e){ state.data={}; } }
    function calcTotals(plan){
      const monthMain=Array(12).fill(0); let totalMain=0;
      plan.employees.forEach(emp=>{
        if(emp.include===false) return;
        emp.values.forEach((v,i)=>{ const val=Number(v)||0; monthMain[i]+=val; totalMain+=val; });
      });
      const monthExtra=Array(12).fill(0); let totalExtra=0;
      plan.extras.forEach(ex=>{
        if(ex.include===false) return;
        ex.values.forEach((v,i)=>{ const val=Number(v)||0; monthExtra[i]+=val; totalExtra+=val; });
      });
      const combined=monthMain.map((v,i)=>v+monthExtra[i]);
      combinedAvg=(totalMain+totalExtra)/12;
      const maxVal=Math.max(...monthMain);
      const maxIdx=monthMain.indexOf(maxVal);

      if(els.sumYear) els.sumYear.textContent=fmt(totalMain);
      if(els.avgMonth) els.avgMonth.textContent=fmt(totalMain/12);
      if(els.peakMonth) els.peakMonth.textContent=maxVal>0?`${MONTHS[maxIdx]} (${fmt(maxVal)})`:'-';
      document.querySelectorAll('[data-sum-month]').forEach(c=>{ c.textContent=fmt(monthMain[Number(c.dataset.sumMonth)]); });
      const totalCell=document.querySelector('[data-total-year]'); if(totalCell) totalCell.textContent=fmt(totalMain/12);

      document.querySelectorAll('[data-extra-month]').forEach(c=>{ c.textContent=fmt(monthExtra[Number(c.dataset.extraMonth)]); });
      const totalExtraCell=document.querySelector('[data-total-extra]'); if(totalExtraCell) totalExtraCell.textContent=fmt(totalExtra/12);

      document.querySelectorAll('[data-combined-month]').forEach(c=>{ c.textContent=fmt(combined[Number(c.dataset.combinedMonth)]); });
      const totalCombinedCell=document.querySelector('[data-total-combined]'); if(totalCombinedCell) totalCombinedCell.textContent=fmt(combinedAvg);

      updatePlanRow();
    }

    function sortList(list,key){
      const dir=state.sortDir==='asc'?1:-1;
      list.sort((a,b)=>{
        const va=(key==='avg'? (a.values||[]).reduce((x,y)=>x+Number(y||0),0)/12 : (a[key]||'')).toString().toLowerCase();
        const vb=(key==='avg'? (b.values||[]).reduce((x,y)=>x+Number(y||0),0)/12 : (b[key]||'')).toString().toLowerCase();
        if(va<vb) return -1*dir;
        if(va>vb) return 1*dir;
        return 0;
      });
    }
    function updateSortIndicators(){
      document.querySelectorAll('[data-sort-ind]').forEach(span=>{
        const key=span.dataset.sortInd;
        if(state.sortKey===key) span.textContent=state.sortDir==='asc'?'▲':'▼';
        else span.textContent='';
      });
    }

    function renderQualBadge(label,id,type){
      const text=label?label:'Qualifikation waehlen';
      return `<button class="qual-badge" data-qual-badge="${type}" data-id="${id}"><span>${text}</span><span>&#9660;</span></button>`;
    }

    function renderTable(){
      const plan=getCurrentPlan();
      if(state.sortKey==='pnr') sortList(plan.employees,'personalNumber');
      if(state.sortKey==='name') sortList(plan.employees,'name');
      if(state.sortKey==='avg') sortList(plan.employees,'avg');
      els.tbody.innerHTML='';
      plan.employees.forEach(emp=>{
        const tr=document.createElement('tr');
        if(emp.hiddenRow) tr.classList.add('row-muted');
        tr.dataset.id=emp.id;
        let tds=`<td class="pnr-cell"><input class="name-input" data-field="pnr" placeholder="z.B. 1001" value="${displayPersonalNumber(emp.personalNumber)}"></td>`;
        tds+=`<td><input class="name-input" data-field="name" value="${emp.name||''}"></td>`;
        emp.values.forEach((val,idx)=>{ tds+=`<td class="month-col"><input class="vk-input" type="number" min="0" step="0.01" value="${val}" data-month="${idx}"></td>`; });
        const rowAvg=emp.values.reduce((a,b)=>a+Number(b||0),0)/12;
        tds+=`<td data-row-sum>${fmt(rowAvg)}</td>`;
        tds+=`<td style="min-width:140px;">${renderQualBadge(emp.qual,emp.id,'emp')}</td>`;
        tds+=`<td class="actions-cell"><div class="action-buttons"><button class="icon-btn menu-btn" data-action="menu-emp" title="Optionen">${ICON_MENU}</button><button class="icon-btn" data-action="delete" aria-label="Loeschen">${ICON_TRASH}</button></div></td>`;
        tr.innerHTML=tds;
        els.tbody.appendChild(tr);
      });
      calcTotals(plan);
      updateSortIndicators();
    }

    function renderExtras(){
      const plan=getCurrentPlan();
      if(state.sortKey==='pnr-ex') sortList(plan.extras,'personalNumber');
      if(state.sortKey==='cat-ex') sortList(plan.extras,'category');
      if(state.sortKey==='avg-ex') sortList(plan.extras,'avg');
      els.extrasTbody.innerHTML='';
      plan.extras.forEach(ex=>{
        const tr=document.createElement('tr');
        if(ex.hiddenRow) tr.classList.add('row-muted');
        tr.dataset.id=ex.id;
        let tds=`<td class="pnr-cell"><input class="name-input" data-field="pnr" placeholder="z.B. 2001" value="${displayPersonalNumber(ex.personalNumber)}"></td>`;
        tds+=`<td><input class="name-input" data-field="category" value="${ex.category||''}"></td>`;
        ex.values.forEach((val,idx)=>{ tds+=`<td class="month-col"><input class="vk-input" type="number" min="0" step="0.01" value="${val}" data-month="${idx}"></td>`; });
        const rowAvg=ex.values.reduce((a,b)=>a+Number(b||0),0)/12;
        tds+=`<td data-row-sum>${fmt(rowAvg)}</td>`;
        tds+=`<td style="min-width:140px;">${renderQualBadge(ex.qual,ex.id,'extra')}</td>`;
        tds+=`<td class="actions-cell"><div class="action-buttons"><button class="icon-btn menu-btn" data-action="menu-extra" title="Optionen">${ICON_MENU}</button><button class="icon-btn" data-action="delete-extra" aria-label="Loeschen">${ICON_TRASH}</button></div></td>`;
        tr.innerHTML=tds;
        els.extrasTbody.appendChild(tr);
      });
      calcTotals(plan);
      updateSortIndicators();
    }

    function recalcRow(tr,item){
      tr.querySelectorAll('.vk-input').forEach(inp=>{ const idx=Number(inp.dataset.month); item.values[idx]=Number(inp.value)||0; });
      const avg=item.values.reduce((a,b)=>a+Number(b||0),0)/12;
      const sumCell=tr.querySelector('[data-row-sum]');
      if(sumCell) sumCell.textContent=fmt(avg);
    }

    function openQualPopover(type,id,anchor){
      const rect=anchor.getBoundingClientRect();
      const plan=getCurrentPlan();
      const list=type==='emp'?plan.employees:plan.extras;
      const item=list.find(x=>x.id===id);
      const selected=new Set((item?.qual||'').split(',').map(s=>s.trim()).filter(Boolean));
      els.qualPopover.innerHTML=QUAL_OPTIONS.map(opt=>{
        const checked=selected.has(opt)?'checked':'';
        return `<label><input type="checkbox" data-qual="${opt}" ${checked}>${opt}</label>`;
      }).join('');
      els.qualPopover.dataset.targetType=type;
      els.qualPopover.dataset.targetId=id;
      els.qualPopover.style.display='block';
      els.qualPopover.style.left=`${rect.left+window.scrollX}px`;
      els.qualPopover.style.top=`${rect.bottom+window.scrollY+4}px`;
    }
    function closeQualPopover(apply){
      if(els.qualPopover.style.display!=='block') return;
      if(apply){
        const type=els.qualPopover.dataset.targetType;
        const id=els.qualPopover.dataset.targetId;
        const plan=getCurrentPlan();
        const list=type==='emp'?plan.employees:plan.extras;
        const item=list.find(x=>x.id===id);
        if(item){
          const checked=Array.from(els.qualPopover.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.qual);
          item.qual=checked.join(', ');
          saveStorage();
          renderTable();
          renderExtras();
          syncRemoteDebounced();
        }
      }
      els.qualPopover.style.display='none';
      els.qualPopover.dataset.targetType='';
      els.qualPopover.dataset.targetId='';
    }

    function openActionMenu(type,id,anchor){
      const plan=getCurrentPlan();
      const list=type==='emp'?plan.employees:plan.extras;
      const item=list.find(x=>x.id===id);
      if(!item) return;
      actionTarget={type,id};
      const rect=anchor.getBoundingClientRect();
      const hideLabel=item.hiddenRow?'Zeile einblenden':'Zeile ausblenden';
      els.actionMenu.innerHTML=[
        `<button data-act="toggle-hide">${hideLabel}</button>`,
        `<button data-act="copy-forward">Ab Monat fortfuehren</button>`,
        `<button data-act="copy-next-year">Ins Folgejahr uebernehmen (DB)</button>`
      ].join('');
      els.actionMenu.style.display='block';
      els.actionMenu.style.left=`${rect.left+window.scrollX}px`;
      els.actionMenu.style.top=`${rect.bottom+window.scrollY+4}px`;
    }
    function closeActionMenu(){ els.actionMenu.style.display='none'; actionTarget=null; }

    function syncRemoteDebounced(){
      if(!supabaseClient||!HAS_SITE) return;
      clearTimeout(syncRemoteDebounced.t);
      syncRemoteDebounced.t=setTimeout(()=>{ syncRemotePlan().catch(err=>console.warn('Sync failed',err)); },700);
    }
    function bindEvents(){
      els.deptSelect.addEventListener('change',()=>{
        state.dept=els.deptSelect.value;
        renderTable(); renderExtras(); saveStorage();
        fetchRemotePlan().then(remote=>{ if(remote){ const key=`${state.dept}-${state.year}`; state.data[key]=remote; ensureDefaults(state.data[key]); saveStorage(); renderTable(); renderExtras(); calcTotals(getCurrentPlan()); loadPlanValue(); }});
        loadPlanValue();
      });
      els.yearInput.addEventListener('change',()=>{
        state.year=Math.max(YEAR_MIN,Math.min(YEAR_MAX,Number(els.yearInput.value)||YEAR_MIN));
        els.yearInput.value=state.year;
        renderTable(); renderExtras(); saveStorage();
        fetchRemotePlan().then(remote=>{ if(remote){ const key=`${state.dept}-${state.year}`; state.data[key]=remote; ensureDefaults(state.data[key]); saveStorage(); renderTable(); renderExtras(); calcTotals(getCurrentPlan()); loadPlanValue(); }});
        loadPlanValue();
      });

      document.querySelectorAll('[data-sort]').forEach(th=>{
        th.style.cursor='pointer';
        th.addEventListener('click',()=>{
          const key=th.dataset.sort;
          state.sortDir=(state.sortKey===key && state.sortDir==='asc')?'desc':'asc';
          state.sortKey=key;
          renderTable();
          renderExtras();
        });
      });

      document.getElementById('btnAddRow').addEventListener('click',()=>{
        const p=getCurrentPlan();
        p.employees.push({id:crypto.randomUUID(),personalNumber:'',name:'Neu',include:true,qual:'',values:Array(12).fill(0)});
        renderTable(); calcTotals(p); saveStorage(); syncRemoteDebounced();
      });
      document.getElementById('btnAddExtra').addEventListener('click',()=>{
        const p=getCurrentPlan();
        p.extras.push({id:crypto.randomUUID(),personalNumber:'',category:'Neu',include:true,qual:'',values:Array(12).fill(0)});
        renderExtras(); calcTotals(p); saveStorage(); syncRemoteDebounced();
      });
      const btnSave=document.getElementById('btnSaveDb');
      if(btnSave) btnSave.addEventListener('click', async()=>{
        try{ setSaveStatus('Speichere ...'); await syncRemotePlan(); setSaveStatus('Gespeichert.'); }
        catch(err){ setSaveStatus(err.message||'Speichern fehlgeschlagen',true); }
      });

      els.tbody.addEventListener('input',e=>{
        const tr=e.target.closest('tr'); if(!tr) return;
        const id=tr.dataset.id;
        const plan=getCurrentPlan();
        const emp=plan.employees.find(x=>x.id===id);
        if(!emp) return;
        if(e.target.classList.contains('name-input')){
          if(e.target.dataset.field==='name') emp.name=e.target.value;
          else emp.personalNumber=persistPersonalNumber(e.target.value,false);
        }
        if(e.target.classList.contains('vk-input')){
          recalcRow(tr,emp);
          lastFocused={type:'emp',id,month:Number(e.target.dataset.month)};
        }
        calcTotals(plan); saveStorage(); syncRemoteDebounced();
      });
      els.tbody.addEventListener('click',e=>{
        const badge=e.target.closest('[data-qual-badge="emp"]');
        if(badge){ openQualPopover('emp',badge.dataset.id,badge); return; }
        const btn=e.target.closest('button[data-action]');
        const tr=e.target.closest('tr');
        if(!btn||!tr) return;
        const plan=getCurrentPlan();
        const id=tr.dataset.id;
        const emp=plan.employees.find(x=>x.id===id);
        if(!emp) return;
        if(btn.dataset.action==='menu-emp'){
          openActionMenu('emp',id,btn);
        } else if(btn.dataset.action==='delete'){
          if(!confirm('Eintrag loeschen?')) return;
          plan.employees=plan.employees.filter(x=>x.id!==id);
          renderTable(); calcTotals(plan); saveStorage(); syncRemoteDebounced();
        }
      });

      els.extrasTbody.addEventListener('input',e=>{
        const tr=e.target.closest('tr'); if(!tr) return;
        const id=tr.dataset.id;
        const plan=getCurrentPlan();
        const ex=plan.extras.find(x=>x.id===id);
        if(!ex) return;
        if(e.target.classList.contains('name-input')){
          if(e.target.dataset.field==='category') ex.category=e.target.value;
          else ex.personalNumber=persistPersonalNumber(e.target.value,true);
        }
        if(e.target.classList.contains('vk-input')){
          recalcRow(tr,ex);
          lastFocused={type:'extra',id,month:Number(e.target.dataset.month)};
        }
        calcTotals(plan); saveStorage(); syncRemoteDebounced();
      });
      els.extrasTbody.addEventListener('click',e=>{
        const badge=e.target.closest('[data-qual-badge="extra"]');
        if(badge){ openQualPopover('extra',badge.dataset.id,badge); return; }
        const btn=e.target.closest('button[data-action]');
        const tr=e.target.closest('tr');
        if(!btn||!tr) return;
        const plan=getCurrentPlan();
        const id=tr.dataset.id;
        const ex=plan.extras.find(x=>x.id===id);
        if(!ex) return;
        if(btn.dataset.action==='menu-extra'){
          openActionMenu('extra',id,btn);
        } else if(btn.dataset.action==='delete-extra'){
          if(!confirm('Zusatzzeile loeschen?')) return;
          plan.extras=plan.extras.filter(x=>x.id!==id);
          renderExtras(); calcTotals(plan); saveStorage(); syncRemoteDebounced();
        }
      });

      document.addEventListener('click',e=>{
        const insidePopover=els.qualPopover.contains(e.target);
        const isBadge=e.target.closest('[data-qual-badge]');
        if(els.qualPopover.style.display==='block' && !insidePopover && !isBadge){
          closeQualPopover(true);
        }
        const insideMenu=els.actionMenu.contains(e.target);
        const isMenuBtn=e.target.closest('.menu-btn');
        if(els.actionMenu.style.display==='block' && !insideMenu && !isMenuBtn){
          closeActionMenu();
        }
      });
      els.qualPopover.addEventListener('click',e=>{ if(e.target.tagName==='INPUT') e.stopPropagation(); });
      els.actionMenu.addEventListener('click', async e=>{
        const act=e.target.dataset.act;
        if(!act||!actionTarget) return;
        const plan=getCurrentPlan();
        const list=actionTarget.type==='emp'?plan.employees:plan.extras;
        const item=list.find(x=>x.id===actionTarget.id);
        if(!item) return;
        if(act==='toggle-hide'){
          item.hiddenRow=!item.hiddenRow;
          item.include=item.hiddenRow?false:true;
          saveStorage(); renderTable(); renderExtras(); calcTotals(plan); syncRemoteDebounced(); closeActionMenu(); return;
        }
        if(act==='copy-forward'){
          const start=(lastFocused && lastFocused.id===actionTarget.id && lastFocused.type===actionTarget.type)?Number(lastFocused.month):0;
          const src=Number(item.values[start])||0;
          for(let i=start;i<12;i++) item.values[i]=src;
          saveStorage(); renderTable(); renderExtras(); calcTotals(plan); syncRemoteDebounced(); closeActionMenu(); return;
        }
        if(act==='copy-next-year'){
          const nextYear=state.year+1;
          if(nextYear>YEAR_MAX){ alert('Jahr ausserhalb Range.'); closeActionMenu(); return; }
          if(!API_BASE){ alert('API-Basis fehlt (clinicon_api_base / CLINICON_API_BASE).'); closeActionMenu(); return; }
          try{
            const payload={ table: tableName(TABLE_EMP_BASE), fromYear: state.year, toYear: nextYear, ids:[item.id], mode:'overwrite' };
            const res=await fetch(API_BASE+'/api/rollover',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const data=await res.json(); if(!res.ok||data.success===false) throw new Error(data.error||res.statusText);
            alert('Rollover abgeschlossen.');
          }catch(err){ alert('Fehler beim Rollover: '+(err.message||err)); }
          closeActionMenu(); return;
        }
      });
    }

    function setDefaults(){
      els.deptSelect.innerHTML=DEPARTMENTS.map(d=>`<option value="${d}">${d}</option>`).join('');
      els.deptSelect.value=state.dept;
      els.yearInput.value=state.year;
    }

    (function init(){
      loadStorage();
      setDefaults();
      renderTable();
      renderExtras();
      if(HAS_SITE && supabaseClient){
        fetchRemotePlan().then(remote=>{
          if(remote){
            const key=`${state.dept}-${state.year}`;
            state.data[key]=remote;
            ensureDefaults(state.data[key]);
            saveStorage();
            renderTable();
            renderExtras();
            calcTotals(getCurrentPlan());
          }
        });
      }
      loadPlanValue();
      bindEvents();
      if(!SUPABASE_URL||!SUPABASE_ANON_KEY||!HAS_SITE) setSaveStatus('Supabase/Standort nicht gesetzt.',true);
    })();
  </script>
</body>
</html>
